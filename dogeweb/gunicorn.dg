import '/os'
import '/asyncio'
import '/gunicorn/workers/base'


Worker = subclass base.Worker where run = self ->
  loop = asyncio.new_event_loop!
  asyncio.get_event_loop!.close!
  asyncio.set_event_loop loop
  loop.call_soon $
    _notify = ->
      @notify!
      not @alive or @ppid != os.getppid! => loop.stop!
      loop.call_later 1 _notify
  @wsgi.run sock: @sockets loop: loop
