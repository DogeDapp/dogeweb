<div class="highlight"><pre><span class="n">wssrv</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">upgrade</span>
  <span class="s">&#39;http&#39;</span><span class="o">,</span>      <span class="o">~&gt;</span> <span class="o">@</span><span class="n">abort</span> <span class="mi">405</span>
  <span class="s">&#39;websocket&#39;</span><span class="o">,</span> <span class="o">~&gt;</span> <span class="o">@</span><span class="n">websocket</span> <span class="o">$</span> <span class="nb">input</span> <span class="n">output</span> <span class="o">-&gt;</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">add</span> <span class="n">output</span>
    <span class="kr">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">input</span> <span class="o">=&gt;</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="kr">except</span> <span class="n">err</span> <span class="o">=&gt;</span> <span class="kr">yield</span> <span class="n">from</span> <span class="n">f</span>
                   <span class="n">err</span> <span class="o">::</span> <span class="ne">GeneratorExit</span> <span class="o">=&gt;</span> <span class="n">break</span><span class="o">!</span>
      <span class="n">msg</span><span class="o">.</span><span class="n">is_data</span> <span class="o">=&gt;</span> <span class="kr">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outputs</span> <span class="o">=&gt;</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span> <span class="n">msg</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">remove</span> <span class="n">output</span>
</pre></div>
